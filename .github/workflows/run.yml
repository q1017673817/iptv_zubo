# .github/workflows/iptv_updater.yml
name: IPTV List Updater

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  OUTPUT_DIR: output
  CONFIG_DIR: zubo

jobs:
  update-lists:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write  # å¿…é¡»çš„æäº¤æƒé™

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        persist-credentials: false  # ä½¿ç”¨GITHUB_TOKENéªŒè¯

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp ratelimit

    - name: Initialize directories
      run: |
        mkdir -p ${{ env.OUTPUT_DIR }} ${{ env.CONFIG_DIR }}
        # å®‰å…¨åˆ›å»ºç¤ºä¾‹æ–‡ä»¶ï¼ˆä»…å½“ä¸å­˜åœ¨æ—¶ï¼‰
        [ -f config.txt ] || echo "192.168.1.0:8000,1" > config.txt
        [ -f ${{ env.CONFIG_DIR }}/æ¹–å—_ç”µä¿¡.txt ] || \
          echo "æ¹–å—å«è§†,udp://225.1.1.1:5000" > ${{ env.CONFIG_DIR }}/æ¹–å—_ç”µä¿¡.txt

    - name: Run IPTV Scanner
      run: python main.py
      env:
        PYTHONUNBUFFERED: 1  # å®æ—¶è¾“å‡ºæ—¥å¿—

    - name: Commit updated lists
      run: |
        # é…ç½®Gitèº«ä»½
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        # ä»…æ·»åŠ ç›®æ ‡æ–‡ä»¶
        git add ${{ env.OUTPUT_DIR }}/iptv_list.txt

        # ç”Ÿæˆå¸¦æ—¶åŒºçš„æäº¤ä¿¡æ¯
        COMMIT_TIME=$(date +"%Y-%m-%d %H:%M:%S (UTC)")
        COMMIT_MSG="ğŸ”„ Auto-update IPTV lists - $COMMIT_TIME"

        # æ¡ä»¶æäº¤
        if git diff --cached --quiet; then
          echo "ğŸŸ¢ No changes to commit"
        else
          git commit -m "$COMMIT_MSG"
          git push origin HEAD:main
          echo "âœ… Successfully pushed updates"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: iptv-lists
        path: |
          ${{ env.OUTPUT_DIR }}/*.txt
        retention-days: 3
